<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Online</title>
    <link rel="stylesheet" href="stylechat.css">
</head>

<body>
    <div class="container" style="display:none;">
        <div id="chat-box" class="chat-box"></div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="Digite sua mensagem...">
            <button id="send-btn">Enviar</button>
        </div>
    </div>

    <footer class="footer">In development by Geraldo</footer>

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC9bE3oqC81j9dgtkbeeyOh8EysCvs1lOE",
            authDomain: "chat-geraldo.firebaseapp.com",
            projectId: "chat-geraldo",
            storageBucket: "chat-geraldo.appspot.com",
            messagingSenderId: "327620141075",
            appId: "1:327620141075:web:57bb6d6b337e96efce9fe6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Pega usuário logado
        const userData = JSON.parse(localStorage.getItem('user'));
        if (!userData || !userData.usuario) {
            alert("Você precisa fazer login.");
            window.location.href = "/login/login.html";
        }

        const username = userData.usuario.trim(); // remove espaços extras
        document.querySelector(".container").style.display = "block";

        const chatBox = document.getElementById("chat-box");
        const userInput = document.getElementById("user-input");
        const sendBtn = document.getElementById("send-btn");

        // Função para adicionar mensagens
        function addMessage(senderName, messageText, senderClass) {
            const msg = document.createElement("div");
            msg.classList.add("message", senderClass);

            const nameSpan = document.createElement("strong");
            nameSpan.textContent = senderClass === "user" ? "Você: " : senderName + ": ";
            msg.appendChild(nameSpan);

            const messageSpan = document.createElement("span");
            messageSpan.textContent = messageText;
            msg.appendChild(messageSpan);

            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Recebe mensagens em tempo real
        const q = query(collection(db, "messages"), orderBy("timestamp"));
        onSnapshot(q, snapshot => {
            chatBox.innerHTML = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.username && data.username.trim() === username) {
                    addMessage("Você", data.text, "user");
                } else {
                    addMessage(data.username, data.text, "bot");
                }
            });
        });

        // Envia mensagem
        sendBtn.addEventListener("click", async () => {
            const text = userInput.value.trim();
            if (!text) return;
            await addDoc(collection(db, "messages"), {
                username,
                text,
                timestamp: serverTimestamp()
            });
            userInput.value = "";
        });

        userInput.addEventListener("keypress", e => {
            if (e.key === "Enter") sendBtn.click();
        });
    </script>
</body>

</html>